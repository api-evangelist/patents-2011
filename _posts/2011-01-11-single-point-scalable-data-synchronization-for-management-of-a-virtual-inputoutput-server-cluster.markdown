---

title: Single point, scalable data synchronization for management of a virtual input/output server cluster
abstract: A method, data processing system and computer program product provide scalable data synchronization for a virtual input/output server (VIOS) cluster and one or more registered callers. A first VIOS is commits as a primary node of the VIOS cluster and performs the functions of: registering one or more callers to receive notification from the first VIOS of specific events occurring within the cluster; receiving notification of an occurrence of one of the specific events; and in response to receiving notification of the specific events, a deamon of the first VIOS retrieving a message payload file from a message payload file directory within the shared VIOS DB and passing the message payload file to the API, which forwards/posts the relevant event notification information from the message payload file to the TCP socket of each registered caller.
url: http://patft.uspto.gov/netacgi/nph-Parser?Sect1=PTO2&Sect2=HITOFF&p=1&u=%2Fnetahtml%2FPTO%2Fsearch-adv.htm&r=1&f=G&l=50&d=PALL&S1=08949828&OS=08949828&RS=08949828
owner: International Business Machines Corporation
number: 08949828
owner_city: Armonk
owner_country: US
publication_date: 20110111
---
The present invention relates in general to distributed data processing systems and in particular to distributed data processing systems with cluster aware virtual input output servers VIOSes . Still more particularly the present invention relates to a method data processing system and computer program product that enable election of primary nodes within a VIOS cluster.

Each Virtual Input Output Server VIOS can provide I O resources to hundreds of virtual machines. In one configuration thousands of virtual storage block devices can be exported to hundreds of virtual machines. With such configurations management of all of these devices becomes very difficult. Management tools have been proposed to attempt to improve manageability for these virtual devices. One such tool stores object data into the tool s local data store db2 database . This database is populated by first discovering the endpoints on the VIOS and then querying for resources. However with this tool once the discovery is complete the tool continuously polls all VIOS partitions in the tool s domain to keep the data within the tool s local data store in a current state. Use of this tool provides a solution that is not scalable and makes the tool unusable in a cluster environment.

Disclosed are a method data processing system and a computer program product that provide scalable data synchronization for a virtual input output server VIOS cluster and one or more registered callers. The method is performed by a first VIOS within the VIOS cluster that is elected as a primary node. The method comprises committing the first VIOS as a primary node of the VIOS cluster registering one or more callers to receive notification from the first VIOS of specific events occurring within the cluster receiving notification of an occurrence of one of the specific events and in response to receiving notification of the occurrence of one of the specific events automatically forwarding information of the specific event to each of the one or more registered callers.

In one embodiment registering the one or more callers to receive notification comprises registering a transmission control protocol TCP socket of each caller with an application programming interface API of the first VIOS. Also the automatically forwarding of information of the specific event comprises a daemon of the first VIOS passing a message payload file to the API. The message payload file is retrieved from a message payload file directory within the shared VIOS DB. The automatically forwarding also comprises the API forwarding posting the relevant event notification information from the message payload file to the TCP socket of each registered caller for that type of event occurrence.

In one embodiment receiving notification of an occurrence of one of the specific events further comprises receiving an event notification from a second node of the VIOS cluster parsing the event notification for indentifying information and accessing a message payload file directory within the shared VIOS DB and retrieving a message payload file corresponding to the indentifying information parsed from the event notification.

Further committing the first VIOS as a primary node further comprises notifying each other node within the VIOS cluster that the first VIOS has committed as the primary node in response to determining that the first VIOS no longer meets the requirements to be the primary node initiating a primary node election and withholding the forwarding of information to the registered callers of any received event notification and in response to determining that the first VIOS is no longer the primary node forwarding a request to a new primary node to issue a resynchronization command to allow the callers to register with a current primary node.

In yet another embodiment the method comprises detecting a node drop alert from within the VIOS cluster determining which node has dropped from the VIOS cluster checking a message payload file directory for a payload entry associated with the dropped node responsive to finding a message payload file for the dropped node determining whether the message payload file was completely written before the node dropped in response to the file having been completed written before the node dropped reading the message payload file and posting the LCE for each file to the one or more registered callers and issuing a caller resynchronization command to the one or more callers registered to receive information about node drop events.

Additionally in one embodiment the one or more registered callers comprise a management tool and the one or more specific events are life cycle events LCE and the method further comprises responsive to receiving a command line interface command from the management tool to execute a discovery operation facilitating a discovery operation of the management tool by accessing the VIOS DB and discovering each node within the VIOS cluster returning to the management tool via the API a listing of each node within the VIOS cluster returning to the management tool one or more additional information about one or more of the VIOS cluster and one or more of the nodes within the VIOS cluster and registering the management tool for receipt of notification of an occurrence of each LCE occurring on the nodes of the VIOS cluster.

The above summary contains simplifications generalizations and omissions of detail and is not intended as a comprehensive description of the claimed subject matter but rather is intended to provide a brief overview of some of the functionality associated therewith. Other systems methods functionality features and advantages of the claimed subject matter will be or will become apparent to one with skill in the art upon examination of the following figures and detailed written description.

The above as well as additional objectives features and advantages of the present invention will become apparent in the following detailed written description.

The illustrative embodiments provide a method data processing system and computer program product that provide scalable data synchronization for a virtual input output server VIOS cluster and one or more registered callers. The method is performed by a first VIOS within the VIOS cluster that is elected as a primary node. The method comprises committing the first VIOS as a primary node of the VIOS cluster registering one or more callers to receive notification from the first VIOS of specific events occurring within the cluster receiving notification of an occurrence of one of the specific events and in response to receiving notification of the occurrence of one of the specific events automatically forwarding information of the specific event to each of the one or more registered callers.

In one embodiment registering the one or more callers to receive notification comprises registering a transmission control protocol TCP socket of each caller with an application programming interface API of the first VIOS. Also the automatically forwarding of information of the specific event comprises a daemon of the first VIOS passing a message payload file to the API. The message payload file is retrieved from a message payload file directory within the shared VIOS DB. The automatically forwarding also comprises the API forwarding posting the relevant event notification information from the message payload file to the TCP socket of each registered caller for that type of event occurrence.

In the following detailed description of exemplary embodiments of the invention specific exemplary embodiments in which the invention may be practiced are described in sufficient detail to enable those skilled in the art to practice the invention and it is to be understood that other embodiments may be utilized and that logical architectural programmatic mechanical electrical and other changes may be made without departing from the spirit or scope of the present invention. The following detailed description is therefore not to be taken in a limiting sense and the scope of the present invention is defined by the appended claims and equivalents thereof.

Within the descriptions of the different views of the figures similar elements are provided similar names and reference numerals as those of the previous figure s . The specific numerals assigned to the elements are provided solely to aid in the description and are not meant to imply any limitations structural or functional or otherwise on the described embodiment.

It is understood that the use of specific component device and or parameter names such as those of the executing utility logic firmware described herein are for example only and not meant to imply any limitations on the invention. The invention may thus be implemented with different nomenclature terminology utilized to describe the components devices parameters herein without limitation. References to any specific protocol or proprietary name in describing one or more elements features or concepts of the embodiments are provided solely as examples of one implementation and such references do not limit the extension of the invention to embodiments in which different element feature or concept names are utilized. Thus each term utilized herein is to be given its broadest interpretation given the context in which that terms is utilized. For example as utilized herein the term cluster aware refers to the operational state of each VIOS within the cluster where the VIOSes contain information about which other VIOSes are connected within the cluster the configuration of the different CECs within the DPS supported by the cluster information about which client LPARs are supported by each VIOS and other state and operating information and data related to performing VIO operations using the physical I O devices of the DPS and those of the distributed storage repository storage repository . Cluster awareness is supported by both a shared networked VIOS database and locally maintained copies of VIOS cluster data within each VIOS.

As further described below implementation of the functional features of the invention is provided within processing devices structures and involves use of a combination of hardware firmware as well as several software level constructs e.g. program code . The presented figures illustrate both hardware components and software components within example data processing architecture having a specific number of processing nodes e.g. computing electronic complexes . The illustrative and described embodiments assume that the system architecture may be scaled to a much larger number of processing nodes.

In the following descriptions headings or section labels are provided to separate functional descriptions of portions of the invention provided in specific sections. These headings are provided to enable better flow in the presentation of the illustrative embodiments and are not meant to imply any limitation on the invention or with respect to any of the general functions described within a particular section. Material presented in any one section may be applicable to a next section and vice versa. The following sequence of headings and subheadings are presented within the specification 

With specific reference now to there is depicted a block diagram of an example cluster aware CA distributed data processing system DPS architecture within which the functional aspects of the described embodiments may advantageously be implemented. For simplicity cluster aware distributed DPS architecture shall be referred to herein simply as DPS . DPS comprises a plurality of computing nodes each referred to herein as a computing electronic complex CEC of which CECs A and B are illustrated. The number of CECs within DPS may vary ranging from a single CEC in a smaller system extending up to hundreds or thousands of CECs in larger scaled systems. For simplicity the embodiments shall be described from the perspective of a single CEC CEC A or two CECs CECs A B . Each CEC A B comprises at least one and in most instances a plurality of Virtual Input Output Server also referred to herein as a VIO Server or VIOS with functionality as described below. The actual number of VIOSes within each CEC of DPS is a design feature and may vary. Also supported within each CEC A B are client logical partitions interchangeably referred to as client LPARs or clients of which a first two clients clientA and clientB are illustrated. As described below with reference to client LPARs are logical partitions of a virtualized or operating system partitioned computing system. The actual number of clients within each CEC may vary and could range from a single client to hundreds or thousands of clients without limitation. For efficiency in presenting the inventive concepts herein only two clients are presented within each CEC of the various illustrative and described embodiments.

DPS also comprises a distributed storage facility accessible to each of the CECs and the components within the CECs . Within the described embodiments the distributed storage facility will be referred to as distributed storage repository and the distributed storage repository enables several of the client level functional features provided by the embodiments described herein. Distributed storage repository provides a single view of storage that is utilized by each CEC and for each client of each CEC within a cluster aware distributed system. Distributed storage repository comprises local physical storage and network storage both of which comprise multiple physical storage units e.g. disks solid state drives etc. . The physical disks making up distributed storage repository may be distributed across a storage network e.g. a SAN . Additionally distributed storage repository provides a depository within which is stored and maintained the software utility instruction code OS images client images data system node and client level and or other functional information utilized in maintaining the client level system management and storage level operations features of DPS . In addition to distributed storage repository DPS also comprises a VIOS database DB which may also be a distributed storage facility comprising physical disks across a storage network. VIOS DB or DB is a repository that stores and provides access to various cluster configuration data and other functional components modules and data structures that enable the various cluster aware functionality described herein. In one embodiment portions of distributed storage repository may be allocated to provide storage pools for a cluster. Each VIOS of the cluster maintains a local view of the DB and updates the cluster level information data data structures within DB as such information data is created or updated.

Communication between each VIOS of each CEC as well as with the VIOSes of at least one other CEC is generally supported via a plurality of inter CEC interconnects illustrated as bi directional dashed lines connecting pairs of VIOSes . The arrows indicated two way data exchange or communication between components. In addition to the inter CEC interconnects each VIOS is also connected to distributed storage repository via VIOS to Store or CEC to Store interconnects which are also illustrated as full lined bi directional arrows. Also each VIOS is connected to DB via VIOS to DB interconnects presented as dashed and dotted lines. With the exception of the inter CEC connectors running from a first VIOS e.g. VIOS of a first CEC to a second VIOS e.g. VIOS on the same CEC the various interconnects represent a network level connectivity between the VIOS nodes of the cluster and the DB and the distributed storage repository . As utilized herein references to one or more nodes are assumed to refer specifically to a VIOS within the cluster. DPS also comprises a management console on which a management tool not shown executes.

Turning now to there is illustrated another view of DPS illustrating the network based connection of the CECs to the distributed storage repository and DB . illustrates in greater detail the network connectivity of VIOSes and CECs to each other and to Distributed storage repository . With this view CEC A Node A A and CEC B Node B B comprise similar constructs as presented in . Each CEC within DPS connects to distributed storage repository via one or more networks and or I O interconnect switch fabric generally illustrated as interconnect network fabric . The descriptions and illustrations assume that at least some of the CECs of DPS and distributed storage repository are located remotely from each other including being located in different countries for example such that no direct physical connectivity exists between the respective devices. For simplicity the embodiments are described as having primary interconnect network comprising a private wide area network WAN or a public WAN such as the Internet although other network types e.g. a local area network are possible and supported.

As depicted in one or more embodiments each CEC is also connected to one or more neighbor CECs in order to provide efficient fail over and or mobility support and other functions as described hereinafter. As utilized herein the term neighbor refers to a connected second CEC with which a first CEC is able to communicate and references to a neighbor CEC is not limited to a second CEC in geographic proximity to the first CEC. CEC A A and CEC B B are illustrated connected to each other via some connecting medium which may include a different network such as a local area network or some type of direct interconnect e.g. a fiber channel connection when physically close to each other. The connection between neighbor CECs A and B is illustrated as a direct line connection or a secondary network connection between CECs A and B. However it is appreciated that the connections are not necessarily direct and may actually be routed through the same general interconnect network as with the other CEC connections to distributed storage repository . In one or more alternate embodiments the connections between CECs may be via a different network e.g. network such as a local area network LAN .

Also illustrated by is an initial view of several of the functional and other components provided within an example distributed storage repository and an initial listing of some components of VIOS DB . As depicted each CEC comprises one or more network interfaces and one or more I O adapters to enable the CEC and thus the other components i.e. client partitions of the CEC to engage in network level communication as described below. Specifically each VIOS emulates virtual client I O adapters to enable communication by the client LPARs with distributed storage repository and or other clients within the same CEC or on a different CEC. The VIOSes emulate virtual I O adapters and communicates with distributed storage repository by connecting with corresponding virtual sever I O adapters at distributed storage repository . The VIOSes within each CEC are thus able to support client level access to distributed storage and enable the exchange of system level and client level information with distributed storage repository .

In addition each VIOS also comprises the functional components modules and data to enable the VIOSes within DPS to be aware of the other VIOSes anywhere within the cluster DPS . From this perspective the VIOSes are referred to herein as cluster aware and their interconnected structure within DPS thus enables DPS to also be interchangeably referred to as cluster aware DPS . As a part of being cluster aware each VIOS also connects to VIOS DB via network and communicates cluster level data with DB to support the cluster management functions described herein.

To support the virtual I O operations with the VIOSes and the associated virtual client I O adapters distributed storage repository comprises communication infrastructure . Communication infrastructure comprises network interface s and a plurality of server I O adapters utilized for cluster level communication and enabling access to data code software utility stored on distributed storage repository to complete I O operations thereto. Specifically these server I O adapters are also presented as virtual sever I O adapters which are paired with virtual I O adapters that are assigned to clients of CECs . As further shown with distributed storage repository DSR also comprises a plurality of software firmware and or software utility components including DSR configuration utility DSR configuration data e.g. inodes for basic file system access metadata authentication and other processes and DSR management utility .

To support the cluster awareness features of the DPS and in accordance with the illustrative embodiment distributed storage repository also comprises VIOS database DB in which is stored various data structures generated during set up and or subsequent processing of the VIOS cluster connected processing components e.g. VIOSes and management tool . VIOS DB comprises a plurality of software or firmware components and or and data data modules or data structures several of which are presented in for illustration. Among these components are cluster management CM utility VIO AdapterID data structure cluster configuration data Client identifying ID data structure active nodes list and I O redundancy data among others. Additionally VIOS DB comprises primary node ID and primary node election data modules which are a plurality of different functional components and data that are utilized during an election of a primary node VIOS from among the various nodes in the VIOS cluster. Finally VIOS DB comprises message payload file MPF directory which contains one or more message files received from one or more initiator nodes VIOSes . The message files provide notification of the occurrence of a life cycle event LCE on or detected by the initiator node. Additional detail of components within VIOS DB is provided with the description of presented below. These various components support the various clustering functionality and cluster aware I O operations of the one or more VIOSes as described herein. Additional features of VIOS DB and distributed storage repository as well as the specific components or sub components that enable the various clustering functionality are presented within the description of the remaining figures and throughout the description of the various embodiments.

In one embodiment the initial set up of the storage pools VIOS DB and corresponding data structures is activated by execution of a cluster aware operating system by management tool . Once the infrastructure has been established however maintenance of the infrastructure including expanding the number of nodes where required is performed by the VIOSes in communication with DB and the management tool .

Also associated with DPS of and communicatively coupled to distributed storage repository and DB and VIOSes is management console which may be utilized by an administrator of DPS or of distributed storage repository or DB to access DB or distributed storage repository and configure resources and functionality of DB and of distributed storage repository for access usage by the VIOSes and clients of the connected CECs within the cluster. As shown in and described throughout the specification management tool is implemented within management console . However it is appreciated that resources of any node within DPS may be selected elected to perform the functions of management tool and the selected node would then perform one or more of the below described cluster creation and the other cluster monitoring and management functions utilizing the availability of the resources provided by DB and distributed storage repository .

In an alternate embodiment management tool is an executable module that is executed within a client partition at one of the CECs within DPS . In one embodiment the management tool controls some of the operations of the VIOS cluster and may enable each node within the cluster to maintain current updated information regarding the cluster including providing notification of any changes made to one or more of the nodes within the cluster.

With reference now to there is presented a third view of an example DPS emphasizing a processing system architecture i.e. architecture of the individual CECs and specifically CEC A A . CEC A A CEC A serves as the example CEC that is described in greater detail in and throughout the specification. CEC A is presented as a server that comprises hardware components and software firmware OS components that are logically partition to create a plurality of virtualized machine partitions which are assigned as client logical partitions LPARs and virtual I O servers VIOSes . Hardware components of example CEC A comprises one or more processors A P one or more memories A M and local storage . The processors A P are interconnected with one or a plurality of memories A M and with local storage via a bus interconnect switch or an interconnect fabric not specifically shown . The specific internal connectivity of components which may be distributed across a large scale interconnect fabric is not germane to the described embodiments and no further detail is presented regarding the particular type of interconnectivity between the system hardware components.

Also included within hardware components are one or more physical network interfaces by which CEC A A connects to an external network such as network among others. Additionally hardware components comprise a plurality of I O adapters A E which provides the I O interface for CEC A A. I O adapters A E are physical adapters that enable CEC A to support I O operations via an I O interface with both locally connected and remotely networked connected I O devices including SF storage . Examples of I O adapters include Peripheral Component Interface PCI PCI X or PCI Express Adapter and Small Computer System Interconnect SCSI adapters among others. CEC is logically partitioned such that different I O adapters are virtualized and the virtual I O adapters may then be uniquely assigned to different logical partitions.

Logically located above the hardware level is a virtualization management component provided as a Power Hypervisor PHYP trademark of IBM Corporation as one embodiment. While illustrated and described throughout the various embodiments as PHYP it is fully appreciated that other types of virtualization management components may be utilized and are equally applicable to the implementation of the various embodiments. PHYP has an associated service processor coupled thereto within CEC . Service processor may be used to provide various services for one or more logical partitions. PHYP is also coupled to hardware management controller HMC which exists outside of the physical CEC . Operations of the different logical partitions may be controlled through HMC which is a separate data processing system from which a system administrator may perform various functions such as reallocation of resources to different logical partitions.

CEC A A further comprises a plurality of user level logical partitions LPARs of which a first two are shown represented as individual client LPARs A B within CEC A. According to the various illustrative embodiments CEC A supports multiple clients and other functional operating OS partitions that are created within a virtualized environment. Each LPAR e.g. client LPAR A receives an allocation of specific virtualized hardware and OS resources including virtualized CPU A Memory A OS A local firmware and local storage LStore . Each client LPAR includes a respective host operating system that controls low level access to hardware layer of CEC A and or to virtualized I O functions and or services provided through VIOSes . In one embodiment the operating system s may be implemented using OS which is designed to interface with a partition management firmware such as PHYP and is available from International Business Machines Corporation. It is appreciated that other types of operating systems such as Advanced Interactive Executive AIX operating system a trademark of IBM Corporation Microsoft Windows a trademark of Microsoft Corp or GNU Linux registered trademarks of the Free Software Foundation and The Linux Mark Institute for example may be utilized depending on a particular implementation and OS is used only as an example.

Additionally according to the illustrative embodiment CEC A also comprises one or more VIOSes of which two VIOS A and B are illustrated. In one embodiment each VIOS is configured within one of the memories A M and comprises virtualized versions of hardware components including CPU memory local storage and I O adapters among others. According to one embodiment each VIOS is implemented as a logical partition LPAR that owns specific network and disk I O adapters. Each VIOS also represents a single purpose dedicated LPAR. The VIOS facilitates the sharing of physical I O resources between client logical partitions. Each VIOS allows other OS LPARs which may be referred to as VIO Clients or as Clients to utilize the physical resources of the VIOS via a pair of virtual adapters. Thus VIOS provides virtual small computer system interface SCSI target and shared network adapter capability to client LPARs within CEC . As provided herein VIOS supports Virtual real memory and Virtual shared storage functionality with access to Distributed storage repository as well as clustering functionality.

Within CEC A VIOSes and client LPARs utilize an internal virtual network to communicate. This communication is implemented by API calls to the memory of the PHYP . The VIOS then bridges the virtual network to the physical I O adapter to allow the client LPARs to communicate externally. The client LPARs are thus able to be connected and inter operate fully in a VLAN environment.

Those of ordinary skill in the art will appreciate that the hardware firmware software utility and software components and basic configuration thereof depicted in B and may vary. The illustrative components of DPS and specifically those within CEC A are not intended to be exhaustive but rather are representative to highlight some of the components that are utilized to implement certain of the described embodiments. For example different configurations of data processing systems CECs devices may be provided containing other devices components which may be used in addition to or in place of the hardware depicted and may be differently configured. The depicted example is not meant to imply architectural or other limitations with respect to the presently described embodiments and or the general invention. The CEC depicted in the various figures may be for example an IBM eServer pSeries system a product of International Business Machines Corporation in Armonk N.Y. running the Advanced Interactive Executive AIX operating system or LINUX operating system.

Certain of the features associated with the implementation of a cluster aware VIOS e.g. VIOS of B and are introduced above with reference to the description of the previous figures and particularly . Descriptions of the specific functionality of the VIOS will continue to be provided with reference to the illustrations of B and . As presented by each VIOS is a virtual machine instance that emulates hardware in a virtualized environment. The VIOS is tasked with emulating SCSI storage devices and the VIOS provides client LPARs with access to distributed storage repository in cooperation with the PHYP . Configuration of the VIOS is performed through the hardware management tools of HMC . SCSI storage devices support a set of commands that allow SCSI initiators the ability to control access to storage . Database programs for example may manage access to distributed storage repository through a set of SCSI commands commonly referred to as persistent reserve. Other types of reserves are also supported by VIOS and the collective group of such commands is referred to herein as reserve commands.

As provided herein each VIOS allows sharing of physical I O resources between client LPARs including sharing of virtual Small Computer Systems Interface SCSI and virtual networking. These I O resources may be presented as internal or external SCSI or SCSI with RAID adapters or via Fibre Channel adapters to distributed storage repository . The client LPAR however uses the virtual SCSI device drivers. In one embodiment the VIOS also provides disk virtualization for the client LPAR by creating a corresponding file on distributed storage repository for each virtual disk. The VIOS allows more efficient utilization of physical resources through sharing between client LPARs and supports a single machine e.g. CEC to run multiple operating system OS images concurrently and isolated from each other.

In one or more embodiments the VIOS operating system s is an enhanced OS that includes cluster aware functionality and is thus referred to as a cluster aware OS CA OS . One embodiment for example utilizes cluster aware AIX CAA as the operating system. According to one embodiment cluster awareness enables multiple independent physical systems to be operated and managed as a single system. As provided within VIOS of CEC A VIOS comprises cluster aware CA OS kernel or simply CA OS as well as LPAR function code for performing OS kernel related functions for the VIOS LPARs . When executed within two or more nodes of DPS CA OS enables various clustering functions such as forming a cluster adding members to a cluster and removing members from a cluster as described in greater detail below. CA OS manages the VIOS LPARs and enables the VIOSes within a cluster to be cluster aware. CA OS comprises several functional modules. In the described embodiments CA OS comprises cluster management CM utility which supports the configuration of the VIOS to enable cluster awareness and cluster level functionality such as redundant virtual I O. Each of these additional software components of CA OS may be a functional module within CM utility in one embodiment and each module is thus described as such throughout the remainder of this specification. In one embodiment CM utility may be a separate utility that is locally installed or downloaded from DB for example as an enhancement to an existing OS within a CEC or VIOS when initially configured for operation within the VIOS cluster. CM utility is then executed when configuring the individual VIOS to create or join a cluster and or become a cluster aware node within the VIOS cluster. With this implementation structure CM utility enables the OS to support the various cluster awareness and other cluster level features and functionality. In an alternate embodiment CA OS includes all the clustering features and functionality and established the various features when the CEC VIOS joins the cluster and or during configuration of VIOS to become cluster aware.

In one implementation functional components of CM utility are encoded on local device storage of a corresponding VIOS such that the VIOS becomes automatically configured as a part of the VIOS cluster when the VIOS is initially activated. On initial set up of the VIOS VIOS API kernel extensions and virtual adapters are configured within VIOS to enable communication with the other VIOSes the VIOS DB and with the distributed storage repository . During this initial setup of the VIOS the VIOS executes a registration module of CM utility to register VIOS with the cluster. The registration module enables VIOS to retrieve download or have forwarded from DB on successful registration with the cluster any additional CM software components and or cluster level information and or data required to establish full cluster awareness when the VIOS has completed installation and is activated within the CEC . Thus in one embodiment in addition to the locally stored CA OS components and software modules of CM utility other functional components of CM utility may be downloaded from DB when CEC is powered on or when one or more VIOSes are enabled on CEC . Once the VIOS has completed its setup one or more client LPARs that are activated within CEC may be assigned to VIOS and VIOS subsequently performs the various I O operations initiated by the client as initiator or directed to the client as target . Updates to the local VIOS data may periodically be made as changes are made within the VIOS cluster and or as one or more new client LPARs are added to the CEC requiring VIOS support. In one embodiment CM utility may also enable retrieval and presentation of a comprehensive view of the resources of the entire cluster.

It is appreciated that while various functional aspects of the clustering operations are described as separate components modules and or utility and associated data constructs the entire grouping of different components utility data may be provided by a single executable utility application such as CA OS or CM utility . Thus in one embodiment CA OS executes within VIOS and generates a plurality of functional components within VIOS and within DB . Several of these functional components are introduced within and and others are described throughout the various embodiments provided herein. For simplicity in the descriptions which follow references to CM utility and CA OS will be assumed to be referring to the same general component i.e. CM utility being a subcomponent of CA OS and the terms may be utilized interchangeably throughout the specification.

As further presented by the illustrative embodiments e.g. VIOS includes one or more additional functional modules components such as VIO adapter s interface and virtual I O drivers utility which provides I O functionality to VIOS and enables VIOS to route data traffic to and from data structures and storage within distributed storage repository and or DB . Virtual I O adapter s and CM utility also enable the VIOS to provide each client LPAR with access to the full range of storage accessible within distributed storage repository and other cluster supported functionalities as described herein.

In the illustrative embodiment each client LPAR communicates with VIOS via PHYP . VIOS and client LPAR A B are logically coupled to PHYP which enables supports communication between both virtualized structures. Each component forwards information to PHYP and PHYP then routes data between the different components in physical memory A M . In one embodiment a virtualized interface of I O adapters is also linked to PHYP such that I O operations can be communicated between the different logical partitions and one or more local and or remote I O devices. As with local I O routing data traffic coming in and or out of I O adapter interface or network interface from a remote I O device is passed to the specific VIOS via PHYP .

With the above introduced system configuration of B and a first VIOS through a communication channel established via PHYP grants access to another VIOS through one or more virtual adapters. VIOS includes the functionality to query PHYP for the identity of the Client LPAR on the CEC where the VIOS is currently running.

With the cluster aware VIOS infrastructure different VIOSes associated with different CECs access the distributed storage repository and cluster level information is shared communicated across the VIOS cluster via VIOS DB while each client I O process is being performed. In this manner the VIOS associated with a first client on a first CEC is aware of which SAN disk resources are being accessed by a second client on a second CEC or on the same CEC . With this awareness factored into the I O exchange with the distributed storage repository the VIOS associated with the first client can avoid accessing the same storage resource that is concurrently being utilized by the second client thus preventing data integrity issues which could potentially cause data corruption and client partition crashes.

In one embodiment VIOS functionality is enhanced to enable assigning of client identifiers ID and unique virtual I O adapter IDs in a secure manner while enabling storage pooling within virtual storage within distributed storage repository . According to the described implementation the different clientID vioAdapterID pairings are unique throughout the cluster so that no two clients throughout the entire cluster can share a same virtual adapter and no two vioAdapterIDs are the same within a single client. is a flow chart illustrating the method by which a VIOS on a CEC with DPS enables cluster level communication between a client LPAR and distributed storage repository according to one embodiment. The process begins at block at which the VIOS queries PHYP for the identity of the client LPAR . At block the VIOS creates a unique identifier ID for the client i.e. a ClientID . The VIOS then stores the unique ClientID in ClientID data structure within DB block . The DB and by extension the ClientID data structure are accessible to each VIOS partition in the cooperating cluster DPS . At block the VIOS also generates an identifier for each virtual IT nexus virtual I O AdapterID that is utilized for each virtual adapter assigned to the client LPAR . In one embodiment a client LPAR can have multiple virtual adapters assigned thereto. These vio AdapterIDs are stored in the AdapterID data structure block and are associated with their corresponding clientIDs block . The method illustrated by ends at termination block with each clientID having been associated with the corresponding one or more vio AdapterIDs with DB .

As described herein a cluster is a set of one or more networked VIOS partitions where each VIOS within the cluster has access to a common set of physical volumes. The physical volume resides within the VIOS cluster and is utilized to provide block storage. Implementation of the cluster awareness with the VIOSes of the cluster enables the VIOSes to provide cluster storage services to virtual clients client LPARs . The VIOS software stack provides the following advanced capabilities among others Storage Aggregation and Provisioning Thin Provisioning Virtual Client Cloning Virtual Client Snapshot Virtual Client Migration Distributed Storage Repository Virtual Client Mirroring and Server Management Infrastructure integration. More generally the VIOS protocol allows distributed storage to be viewed as centralized structured storage with a namespace location transparency serialization and fine grain security. The VIOS protocol provides storage pooling distributed storage and consistent storage virtualization interfaces and capabilities across heterogeneous SAN and network accessible storage NAS . In order to provide block storage services utilizing the distributed repository each VIOS configures virtual devices to be exported to virtual clients. Once each virtual device is successfully configured and mapped to a virtual host VHOST adapter the clients may begin utilizing the devices as needed. In one embodiment the virtualization is performed utilizing POWER virtual machine VM virtualization technology which allows the device configuration process to occur seamlessly because the physical block storage is always accessible from the OS partition.

One embodiment provides a communication protocol that enables efficient communication between the Clients and distributed storage repository via the respective VIOS and virtual I O adapters assigned within the VIOSes to the specific client . The embodiment further provides storage virtualization and management via the specific communication mechanisms protocols implemented with respect to the use of cluster awareness and the Distributed storage repository such that the virtualization is presented within the context of the server CEC virtualization and management. With the presented protocol different VIOSes associated with different CECs access the same single distributed DB and cluster level information is shared communicated with each Client I O process such that a first client on a first CEC is aware of which SAN disk resources are being accessed by a second client on a second CEC or on the same CEC . With this awareness factored into the I O exchange with the distributed storage repository the first client can avoid accessing the same storage resource that is concurrently being utilized by the second client thus preventing data integrity issues which would potentially cause data corruption and client partition crashes.

The communication protocol provides a highly integrated server based storage virtualization as well as distributed storage across clustered VIOS partitions. This protocol comprises one or more query features which enables dynamic tracking of storage resource usage across the entire cluster. Throughout the following description the communication and management protocol shall be described as a VIOS protocol. VIOS protocol provides distributed storage across clustered VIOS partitions. With the VIOS protocol the storage is considered as a one large storage pool which chunks of storage i.e. logical units or LUs allocated to each client . The VIOSes within the overall system DPS are now structured as part of the cluster with each VIOS being a node in the cluster. Each VIOS node communicates with other VIOS nodes utilizing the VIOS protocol. With this configuration of VIOSes when two or more client LPARs belonging to different CECs share storage on the SAN e.g. two clients assigned overlapping LUs the VIOS protocol enables each node to query each client within the cluster to determine the current usage of the storage device. When this information is received the VIOS may then disseminate this information to other VIOSes. Each client is thus made aware of whether the SAN storage device that the client is trying to access is currently being used by some other client.

Referring now to there is illustrated an example VIOS communication infrastructure having an application programming interface API controlling the various exchanges between XML components over a virtual Small Computing Systems Interface vSCSI topology. Central to the Cluster VIOS communication paradigm is a plurality of APIs of which API is provided in the illustrative embodiment. The VIOS API is utilized to manage objects within a VIOS cluster. The API includes the necessary information about how to connect to and or exchange information with internal VIOS functional modules as well as with DB DDS and management tool . In one embodiment management tool is implemented within a cluster aware server module and includes server management sub agents which represents the structures utilized by the managing tool to communicate with the operating system. The internal functional modules within VIOS comprises command line interface CLI Daemon socket kernel extension vKE and vSCSI host . The vSCSCI host includes the enhancements to VIOS that enable the cluster aware functionality. These enhancements are illustrated as a connected block structure by which advanced VIOS operations and emulation are provided as described in greater detail below. VIOS with its various internal components is connected within CEC via PHYP as previously illustrated by described above.

Each component that connects with API and makes one or more requests through API is generally referred to as a caller throughout this specification. As presented by the figure any one or management tool via management agent CLI Daemon and vSCSI host may be a caller requesting specific types of information exchange via API . In one embodiment the API comprises an XML interface as well as a C programming language interface. The various callers use the VIOS API to initiate actions on these objects. Some actions may change the state of one or more objects in the VIOS cluster. The VIOS API may be used by multiple callers at any given time. While callers are not aware of other callers using the VIOS API and do not have the ability to notify all callers of actions that they initiate the VIOS API event notification protocol provides cluster level awareness of caller modifications to prevent data contamination during processing of multiple caller requests. Callers that need awareness of actions taken on VIO objects are able to register for event notification and receive notification about changes to VIO objects that occur within the cluster. The callers then utilize the notifications as a trigger to go to the shared storage DB and retrieve the necessary information from the shared VIOS cluster DB to keep the caller s locally stored VIO object data current. Additionally in one embodiment VIOS API event notification provides participating callers with results to actions that have occurred on one or more VIO objects. As described herein these VIO object events are categorized as Lifecycle events or Alert events.

In one embodiment to decrease the amount of APIs required be each consumer only a few high level APIs are exposed. Each API provides various actions on an object by object basis. Interaction between the API and a consumer a caller receiving data in response to a requestor a caller registered to receive notification of an event is performed by the consumer providing a VIO request extensible markup language XML buffer with sufficient amount of data provided in order for the request to be processed. Once the request has been processed a VIO response XML steam is written back to the caller for response processing. When the response indicates a successful processing of the request the XML steam contains the status and the requested object information that is needed. However if the request fails the response XML stream contains VIO exception information. The common format of each object API is to provide a vioRequest structure that contains the required information needed for request processing.

Returning to in the illustrative embodiments a VIOS emulates SCSI devices using a kernel extension vscsi host kernel extension kernel extension in the VIOS partition which also includes the code modules for providing VCSI host and Daemon . VSCSI host includes one or more driver s and sub driver s which provide separate functions. A first set of drivers provides emulation functionality while other drivers provide transport and messaging functionality. VSCSI host includes VIOS enhanced operational functionality illustrated via additional structure4 coupled to VSCSI host . Structure includes software modules that enable the various messaging structures used for implementing VIOS cluster awareness functionality and VIOS Client emulation. Client logs into the VIOS as part of the transport layer protocol. At the time the client logs into the VIOS the PHYP provides information to the VIOS regarding the identity ID of the client relative to the CEC . The VKE services SCSI requests sent by the VIOS through a transport layer supported by PHYP . The kernel code does not complete the login request until the VKE sends a message with the CEC relative client ID using a socket to Daemon which is also running on the VIOS . VKE also transmits other messages within the cluster environment. The user daemon has access through API to Database DB which is maintained by all VIOS partitions servicing the client s within the cluster.

Referring now to there is illustrated an example VIOS cluster communication scenario in which components of a first VIOS A transmits a VIO kernext KE send message to a second VIOS B. Specifically as shown VIOS Daemon of VIOS A A forwards a message via socket interface to sending VKE of the same VIOS A. Sending VKE transmits the Send Message over the kcluster interface to a receiving VKE of the second VIOS B. Once the message is received at the receiving VKE the receiving VKE forwards the message to VIO Daemon of the second VIOS B. The message passing capabilities extend between VIO Daemon and API to which management agent tool is shown to be communicatively coupled. The communication between management agent tool and API is understood to supported be via a TCP socket connection.

In one or more embodiments the Send messages are generated by the VIOS Daemon while received messages are consumed by the VIOS Daemon. The types of messages generated by the Daemon can vary and include a messages requiring receipt notification b messages not requiring receipt notification c messages requiring or triggering generation of a response message and d messages that do not require such response messages. Additionally the Daemon can specify whether the message type is a broadcast message to be sent to all other VIOSes within the cluster or a directed message to be sent to one or more specific VIOSes within the cluster identified by the VIOS es respective IP addresses . In other embodiments the messages can be generated by system administrator functionality via a command line interface CLI to the CA OS of the sending VIOS. Thus according to the described embodiments the process for sending messages at the VIOS level can be provided via a first VKE system call command interface. The first VKE system call or interface can also be utilized by the VIO Daemon VIOD to provide response information to metadata queries of vSCSI host driver . In one embodiment the same VIOD protocol header definition is utilized as with other interfaces with the VIOD. To send a message the VIOS communication protocol defines a new opcode that indicates that the operation is a user space cluster message send operation.

The messaging communication aspects of the described embodiments are implemented via both an intra node messaging construct and an inter node cluster communication protocol. Accordingly the cluster software provides a mechanism to pass messages using a cluster messaging interface command. In order to limit the amount of data transmitted across the network the communication protocol provides a cluster messaging interface to pass a request combined with a distributed file to pass the payload information for a given request. The payload file is optional and only used for requests that require payload information. With this protocol the sequence of events for message passing includes the following 

As introduced above when messaging for LCEs the messaging packets include a payload data that is stored on the VIOS DB which is utilized within the VIOS cluster to enable the various nodes to pass payload information from one node to another. The opcode determines if a message payload file is needed as well as the format and content of the data within the file. According to the described embodiment each message includes message header information. Within the VIOS DB the message payload files are organized based on the initiator node information. Included within the header information or sub header is information indicating characteristics of the message payload file such as whether the file is private the node identifier ID of the initiator node the type of message and the filename or transaction ID.

As described herein implementation of the cluster awareness with the VIOSes of the cluster enables the VIOSes to provide cluster storage services to virtual clients . The VIOS software stack provides the following advanced capabilities among others Storage Aggregation and Provisioning Thin Provisioning Virtual Client Cloning Virtual Client Snapshot Virtual Client Migration Distributed Storage Repository Virtual Client Mirroring and Server Management Infrastructure integration. More generally the VIOS protocol allows distributed storage to be viewed as centralized structured storage with a namespace location transparency serialization and fine grain security. The VIOS protocol provides storage pooling distributed storage and consistent storage virtualization interfaces and capabilities across heterogeneous SAN and network accessible storage NAS . In order to provide block storage services utilizing the distributed repository each VIOS configures virtual devices to be exported to virtual clients. Once each virtual device is successfully configured and mapped to a virtual host VHOST adapter the clients may begin utilizing the devices as needed. In one embodiment the virtualization is performed utilizing POWER virtual machine VM virtualization technology which allows the device configuration process to occur seamlessly because the physical block storage is always accessible from the OS partition. When a virtual target device is removed the local OS cache local storage data entries are deleted. Within the clustered environment removal of any of the LUs is noticed to the other VIOSes. According to the described method a distributed device repository and local repository cache are utilized to ensure the nodes within the cluster become device level synchronized from each node VIOS in the cluster.

According to one embodiment information needed to configure a virtual target device VTD is stored in DB . This database DB can be accessed by all the nodes in the VIOS cluster utilizing services provided by Cluster Aware OS such as but not limited to Cluster Aware AIX CAA . Additionally certain small levels of cluster data are stored in a local database ODM e.g. virtualized portions of storage on each node for the devices which exist on that node. This local storage is necessary in order for the processes running on the local node to be able to match the VIOS device with the correct information in the distributed database.

With information about each device being stored in the DB operations on those devices can be performed from any VIOS node in the cluster not just the node on which the device resides. When an operation on a device is performed on a remote non local node i.e. one other than the node where the device physically resides the operation is able to make any changes to the device s information in the DB as necessary. When corresponding changes are needed in the device s local database the corresponding CM utility enables the remote node to send a message using cluster services to the local node to notify the local node to make the required changes. Additionally when a node in the cluster is booted up or when the node rejoins the cluster after having been lost for any period of time the node will autonomously reference the DB in order to synchronize the data there with the local data of the node.

As an example if an operation to delete a VIOS device from the local node is executed on a remote node the operation will remove the information associated with that device from the DB and send a message to the local node to tell the local node to remove the device from the local database. If the local node is down or not currently a part of the cluster when the local node first boots up or rejoins the cluster the local node will automatically access the DB retrieve current data information that indicates that the information for one of the local devices has been removed and delete that device from the local database records.

As further illustrated by VIOS DB comprises a plurality of additional data structures and or components which are utilized to allow for primary node election registration of listeners and handlers for alert notification during cluster management and life cycle events and enabling synchronization of data for a registered callers via a single primary notification node. Thus comprises message payload file MPF directory within which message file is stored. A local copy of message file is also maintained within a local MPF directory of second initiator node . Primary node also comprises management tool synchronization utility MTSU by which primary node is able to perform the various synchronization functions for updating a registered management tool caller as LCEs occur within the VIOS cluster. According to one embodiment the present of this functional block of code within CA OS is required for a VIOS to take on the role of a primary notification node. In one embodiment an executable copy of MTSU is stored on VIOS DB and available for download to a VIOS that is to be utilized as a potential primary notification node for the VIOS cluster. Additional details of the use of these structures are described in Sections E F and G below.

Due to the potentially large number of VIOSes within the VIOS cluster one or more embodiments provide a mechanism methodology for managing events and actions within the system. According to one embodiment a system and method are provided by which the various nodes within the VIOS cluster detect when there is a need for a primary node elect a primary node and subsequently trigger another election of a next primary node when needed. With this embodiment the election process involves utilizing VIOS DB and the message passing functionality enabled by the VIOS cluster to ensure that whenever possible there is a primary node assigned to maintain and provide cluster information about the nodes within the cluster and to the nodes. In the following descriptions references made to a specific Primary Node will be directed to VIOS A of . One or more of VIOS B or VIOS C then represents the secondary nodes described within the following description.

Referring again to VIOS DB comprises a plurality of functional structures modules and or data associated with the primary node election process described herein. As shown VIOS DB comprises primary node ID and elector ID both of which provides specific functions defined hereafter. Additionally each VIOS comprises a plurality of components that supports the primary node secondary node configuration of a VIOS cluster. As provided within CA OS kernel of each VIOS is cluster registration utility and CM utility . CM utility then comprises node monitor report utility liveliness notifications and alerts . When a VIOS is configured to operate as a primary node that VIOS also comprises primary node election operation utility and either or both primary notification module and primary clean up module .

Utilization of a primary node provides a benefit of scalability for cluster environments in large configurations. According to one embodiment the VIOS cluster environment incorporates role specific VIOS nodes that provide services to other VIOS nodes in the cluster. Among the roles and associated functionality that are provided by one or more VIOS nodes are the roles of posting life cycle events posting alerts journaling alerts and providing Database and general clean up among others. In one embodiment each role can be performed by a separate primary node such that an unlimited number of primary nodes may be defined within the cluster. The number of primary nodes can be based on the functionality needed and each function could in one or more embodiments have a separate primary node assigned to perform that particular function. According to the illustrative embodiment and as illustrated by the above roles can be provided by two primary nodes Primary Notification node and Primary Clean up node . Each node that is elected to the role of primary node first meets specific pre established requirements.

Assigning a VIOS the role of primary node is provided through an election process. In the presented embodiment a first VIOS node detects that a primary node election is needed and the first node initiates the election process. When the node detects that an election is needed the node checks its own configuration parameters against the requirements published for a node to become the primary node. The node determines whether the node itself meets the requirements e.g. by having a pre established set of primary node modules data configuration to allow the node to become the primary node. If the node does not meet the established requirements the node becomes the elector node and activates a discovery process that discovers and notifies a next node e.g. from within the elector order list of the need for a primary node . The next node may then become the candidate node if the next node meets the requirements to become a candidate.

According to one embodiment a VIOS has to meet several requirements to qualify to become designated or elected as a primary notification node including one or more of the following non exclusive list of requirements a the node must be a part of the VIOS cluster b the node must be part of the VIOS DB cluster and have the ability to write the event payload to the VIOS DB file and c the node should have one or more TCP socket connection s established with the required callers e.g. management tool .

When the node meets the established requirements the node determines whether the primary node ID field is locked in the VIOS DB by another node. If the primary node ID field is locked the node sets a primary node election timer to track the elapsed time since the node last attempted to become the primary node. The timer expires after an amount of time e.g. a pre set time period elapses that is either a design choice or dynamically determined based on the number of nodes within the cluster and or other quantifiable factors. Assuming that no other node has locked the primary node ID field the node locks the Primary Node ID field within VIOS DB and the node initiates the primary node commit process. The node sends a COMMIT signal to VIOS DB and updates the primary node ID field with the node s own unique ID. The node then unlocks the Primary Node ID field .

When the established primary node prepares to take any primary node specific actions the primary node first generates and issues a query to VIOS DB to ensure that the node is still the primary node before the node takes the action. For example before the primary notification node posts a life cycle event LCE the node will issue a query to VIOS DB and specifically to check the value of the Primary Node ID stored within the Primary Node ID field to confirm that the node is still the Notification Primary Node i.e. checking that the node s ID matches that stored as the Primary Node ID . If another node has committed as the primary the node retrieves the primary node ID from the primary node ID field and updates the node s local copy of the primary node ID.

When a primary node no longer meets the requirements to be a primary node the node undertakes the process or relinquishing the primary role. The process involves the primary node updating the Primary Node ID in VIOS DB to a null zero value and discovering the next candidate in the ordered list as previously described.

According to the described embodiments one or more triggers initiate the primary node election process when there is no primary node elected or the present primary node cannot fulfill the primary node role. Among these triggers are those presented within the following non exclusive list 

Election of a Primary Notification Node also occurs in response to the following conditions 1 When a LCE event or alert is received by a node the daemon checks if there is a primary node. If there is currently no primary node then the VIO daemon initiates the election process and 2 When a caller registers a socket for event notification the VIO daemon checks if there is a Primary Notification Node and the VIO daemon initiates the election process if there is no primary notification node.

The above described infrastructure of a VIOS cluster having mechanisms for autonomously electing primary nodes including a primary notification node and the communication facility for monitoring events within the cluster and passing relevant event information to the primary node. A further enhancement provides for a management tool to scalably synchronize collected cluster data cluster configuration and management CCM data by registering with a single point of access to the cluster the primary node for synchronized updates of events occurring within the cluster. Specifically as described hereinafter embodiments are presented for a method and framework to provide notification to a management tool for addition modification and removal of data objects on the VIOS cluster. The embodiments provide for scalability via the utilization of a primary node that provides all notification information to the management tool as such events occur and if needed the primary node also signals to the management tool to re synchronize the management tool s data store.

As shown by associated with management tool is a management tool accessible associated storage . This storage may be local to the management console or remotely connected. Regardless within the present embodiments management tool first performs a discovery of the entire VIOS cluster via connecting to one or the various nodes of the cluster. As a result of the discovery operation management tool receives initial cluster configuration and management CCM data which management tool stores within storage . Management tool then registers with primary notification node to autonomously receive LCE updates as those updates occur within the VIOS cluster. These LCE updates are also stored within storage and together with the initial CCM data make up a current view of CCM data of the VIOS cluster. As provided herein management tool connects to and registers with the primary notification node via a TCP socket connection to the API of primary notification node

During an election of a Primary Event Node when a socket connection e.g. TCP socket UNIX socket etc. to the required callers does not exist the node sends a registration message request to a defined UNIX socket for the caller to register a socket. Also during the election process any LCE that arrives at VIOS DB will be lost. Then following its election as the primary node the node that wins the election process issues a resend re synchronize message to the caller s whose LCE was lost during the primary node election process.

Once the primary node is elected the primary node undertakes to perform several tasks functions dependent on the services the primary node provides. An example of these tasks functions are a notification function by which the primary node broadcasts an election complete message with an election success status including the primary node s ID and primary node role e.g. notification or and cleanup role to the other VIOSes within the cluster. This broadcast is only performed by the newly elected primary node. Each non primary secondary node that receives this message updates the node s local memory with the new Primary Node ID and the non primary node also stops any election timing the node may have initiated. Another task function performed by the newly elected primary node involves taking role specific actions. Specifically a Primary Notification Node issues the caller resynchronization message request to the caller on the socket after the election completion message is returned. This resynchronization notification is needed because any events that occur during the election process may be lost. Also the Primary notification node listens to and posts Alerts. The Primary Cleanup Node performs the tasks of gathering the active node list and take actions based on inactive nodes cleaning up database entries performing clean up based on journal entries future and listens to and journals alerts. Once a primary node is elected the non primary nodes automatically stop their respective election process timers and load the new Primary Node ID into their respective node local memory. In one embodiment the Primary Notification node reads the journaled alerts and posts all alerts that occurred during the election process to management tools.

Thus implementation of the various embodiments provides a method and protocol to provide a scalable notification framework that allows the management tool to keep the management tool s data store synchronized with managed resources on all VIOS nodes in the VIOS cluster. Within the messaging and notification framework introduced above each management tool or other component that utilizes the notification framework is referred to as a registered caller or caller. Within this framework the VIOS providing the functions of the primary node is responsible for sending events to registered callers and in one embodiment only the primary node sends events to the one or more callers to prevent overlaps in the information received by the caller. Any event of interest e.g. life cycle events LCE that are recorded or seen on a non primary node within the cluster is forwarded to the primary node. The primary node then posts the events of importance to a registered caller via subscription of the registered caller for receipt of notification of such events to the TCP socket of the registered caller s . As defined herein a life cycle event is an event occurring within of affecting one of a node a connection one or more partitions serviced by the node or a resource of the cluster that changes the configuration of the cluster and which can affect one or more operations of the node the specific resource or the cluster as a whole. Life cycle events track creation and destruction of particular resources within the cluster. Specific examples of LCEs comprise adding a node to the cluster removing a node from the cluster creating a resource such as a logical unit LU and removing a resource logical unit . Other events that may be of interest but are not life cycle events include but are not limited to a loss of communication between one or more VIOS with a each other b the VIOS DB c the shared repository and a failure of the VIOS that prevents the VIOS from being able to continue to provide I O functionality for one or more assigned client LPARs. By registering to receive LCEs from a single node within the VIOS cluster the management tool can quickly respond to received user requests because a local cache of resources configuration available within the cluster can be managed without polling the large number of nodes within the cluster.

Within the VIOS cluster posting of LCEs involves several actions. In one or more embodiments these actions assume that a caller has already registered the caller s TCP socket connection for event notification from the cluster and that the primary node for event notification has been elected. According to the notification protocol only the primary node sends LCEs to the registered caller. This condition limits the number of LCE the caller sees for a single action and also prevents flooding of the network. In one or more embodiment certain actions taken through the VIOS API can cause a LCE. These actions then cause the VIOS API to send notification to the VIOS daemon that a LCE needs to be posted to registered callers. The VIOS API sends the message header and payload to the VIOS daemon utilizing a Unix socket. Also the VIOS API utilizes a special LCE opcode to notify the VIOS daemon that the request is for a LCE.

As introduced above the one or more registered callers comprise a management tool and the one or more specific events are life cycle events LCE . As further shown by registering the callers comprises a series of registration activities. The method begins with the management tool connecting to the primary node and forwarding a request to receive configuration information about the VIOS cluster and to be registered for notification of changes to such configuration and other events of interest to the management tool generally referred to herein as life cycle events . The primary node API receives via the command line interface a command from the management tool to execute a discovery operation block . Responsive to receiving the discovery request from the management tool the primary node initiates facilitates the discovery operation of the management tool by accessing the VIOS DB and discovering each node within the VIOS cluster block . The primary node then forwards the results of the discovery operation to the management tool block . Specifically the primary node returns to the management tool via the API a listing of each node within the VIOS cluster and one or more additional information about the VIOS cluster and or one or more of the nodes within the VIOS cluster. The primary node then registers the management tool for receipt of notification of an occurrence of each LCE occurring within the cluster and or on the nodes of the VIOS cluster block . The primary node then triggers periodic resynchronization operations of the management tool whenever a life cycle event of relevance to the management tool which modifies the previously discovered VIOS configuration topology occurs block .

Returning now to the primary node then receives notification from an initiator second node of an occurrence of one of the specific LCEs block . The primary node parses the received notification for identifying data information block . Using the identifying data the primary node access the message payload file directory within the VIOS DB and retrieves the message file corresponding to the identifying data block . The daemon of the primary node then automatically forwards relevant data from the message file to the API block and on receipt of this information the API forwards posts the information to the registered callers namely the management tool via their respective TCP socket interfaces block . The primary node then notifies the initiator node that the notification process has completed block . The process then ends at block . With the above process the management tool is able to register with a single device within the entire cluster and maintain synchronization of the relevant data about the various devices within the entire cluster.

In one embodiment the primary node performs the standard checks of a primary node before performing any primary node tasks. When the current primary node determines that the node no longer meets the requirements to be the primary node the node initiates a primary node election and withholds the forwarding of information to the registered callers of any received event notification. Also in response to determining that the first VIOS is no longer the primary node the node forwards a request to the new primary node to issue a resynchronization command to allow the callers to register with the new primary node.

According to one embodiment if the primary node initiates processing of a remote LCE request and determines that the node is no longer the primary node the primary node logs an error within the VIOS DB and fails the request. This feature is provided to prevent loops when handling LCE for remote nodes and to ensure the remote node is aware of which node is the current primary node.

The internal message passing features of the primary node occurs between the API and the daemon of the primary node via the communication protocols described with reference to . The daemon receives the payload of the message sent by the API and the daemon checks whether or not the node is currently the primary node. In response to the daemon determining that the node is the primary node the daemon builds a corresponding Event Notification Payload from the received LCE message payload . The daemon then determines which callers are registered to receive notification of LCEs and the daemon sends the event notification payload to the registered TCP socket s of the registered caller s . Following the transmission of the LCE notification to the registered caller s the daemon then generates and forwards an API response message with status information that is sent to the initiating node.

If the daemon determines that the daemon does not reside on the primary node i.e. the daemon is on a non primary node of the cluster the daemon packages the LCE within a message and forwards the message via respective send and receive VKE s to the daemon of the primary node block . In one embodiment this process can involve one or more functions performed by the non primary node. The non primary node retrieves the primary node ID and then writes a message packet containing the message header and payload information to a LCE payload file within VIOS DB . The non primary node then sends the LCE request and with the location of the message packet to the primary node using the cluster messaging interface command over the kcluster interface . When received by the primary node the cluster message interface command is processes for the received LCE request. First the command reads the LCE packet from the LCE payload file at the VIOS DB and then the command calls the VIOS API to forward the request to the VIOS daemon. The VIOS API builds the request similar to the initial LCE request with the opcode of the re built LCE request changed to indicate to the primary node that the API is posting the LCE on behalf of a remote node. In one embodiment the node ID field in the message header identifies the node that initiated the LCE request. The VIOS daemon then sends the LCE packet to the TCP socket of the registered callers. Following completion of the LCE the primary node returns the status to the calling initiating node. On receipt of the status message the calling node i.e. the node that forwarded the LCE request to the primary node deletes the LCE payload file from the VIOS DB and returns the status to the VIOS API of the initiating node which would typically be the calling node .

When the primary detects a node drop alert the primary node first checks the message payload file directory for a payload entry associated with the node that dropped. If payload files exist for the dropped node the primary node issues a caller resynchronization command to the associated callers. In an alternate embodiment the primary node reads the message files and posts the LCE for each file. This alternate embodiment however assumes that the file has been completely written before the node dies. For those instances in which the file is incomplete a caller resynchronization command has to be issued. Where the initiator node writes the payload file to the VIOS DB then crashes before being able to send the payload file to the cluster messaging interface the initiator node can perform the cleanup of the message payload files either on reboot or re entrance into the cluster.

The existence of the message file within the VIOS DB indicates that the node that dropped had successfully completed the API request and did not have time to clean up the message file before the node went down . This also implies that the node has not yet returned the status of the request to the caller. Thus the object has changed and the caller has not been made aware of this change necessitating the resynchronization of the registered callers. The caller resynchronization provides this notification of the change to the various registered callers. Also the initiator node can cleanup the message payload files on reboot of the initiator node or re entrance of the initiator node into the cluster.

In the situation where there are no messages files associated with the down node within the VIOS DB the primary node does not need to take any further action. Additionally in the situation where the node that dies is the primary node there will be no message payload file. As the LCE may or may not have been posted to the caller s the new primary node issues a caller resynchronization command after the new primary node is elected.

Several features of the described embodiment require the operation of an initiating node to generate the LCE and post the message file to the VIOS DB among other functions. illustrates the method by which certain of these functions are completed including responses to error conditions detected while the initiating node or primary node is attempting to post an LCE event. The method begins at block and proceeds to block at which the non primary node detects an occurrence of a life cycle event LCE affecting the first VIOS and or one or more partitions serviced by the first VIOS or a second VIOS. The non primary node becomes an initiating node and generates a message file containing information about the LCE block . The initiating node then forwards the message file to the VIOS DB and stores the message file to the MPF directory block . The initiator node then forwards a notification message to the primary node to inform the primary node of the occurrence completed or pending of the LCE block . The initiating node then waits for receipt of an acknowledgement from the primary node notifying the initiator node of completion of the notification process and the initiator node determines at block whether the acknowledgement message has been received. When the acknowledgement message is received the initiating node performs a cleanup operation to delete the message file from the VIOS DB MPF directory as well as from the local storage repository of the initiator node block . In one embodiment the acknowledgement from the primary node indicates completion of an API request by the primary node involving receipt of the message file from the VIOS DB

In response to not receiving an acknowledgement within a timeout period which may include a retry of the notification as indicated at block one or more error conditions are assumed to have been encountered. These error conditions are described below with occasional references back to the reminder of the flow chart.

Various different embodiments account for the occurrence of several different errors or possible error scenarios that can be encountered when sending a LCE. In a first error scenario the initiator node dies before the API request is completed no result of block . In a related error condition the initiator node dies after writing the message file to the MPF directory yes result of block and the initiator node then performs a cleanup operation on reboot or re entry of the node to the cluster block . With this possible error condition the primary node continually listens for node drop alerts and responds accordingly as described above with reference to .

Another error condition that can negatively affect the caller notification process involves the scenario where the daemon of the initiator node dies block . In one or more embodiments the VIOS daemon is configured to automatically re spawn itself if the daemon dies block . This re spawning capability allows the daemon to perform special processing when the daemon is initially started or re spawned. Once initiated or re spawned the daemon first checks if any files exist in the local node s message payload directory block . If there are files within the local message payload directory the daemon can check the files for status information. If the status is incomplete the daemon becomes aware that the message has not been posted to the VIOS DB. The daemon can then re send the LCE block . In the scenario where the daemon dies on the primary node then the primary node has to relinquish the primary role and initiate the primary election process once the daemon re spawns itself. Also when a non primary node detects files in the payload directory that are incomplete then the non primary node will forward a request to the primary node for the primary node to issue a caller resynchronization command block .

Another error condition that is accounted for within the messaging framework is an error in which a non primary node cannot write to the message payload file block . The non primary node logs the error and forwards a request to the primary node to issue a caller resynchronization command block . In an alternate embodiment the initiator node can attempt to post the LCE locally within the node local storage repository block . Then in response to the initiator node not being able to post the LCE to its local storage the initiator node requests that the primary node issue a caller resynchronization command to initiate a caller resynchronization event .

Yet another error condition involves the return of an error from the cluster messaging interface kcluster interface block . In response to a non primary initiator node receiving any error from the cluster messaging interface command the non primary initiator node logs an error and initiates the primary election process block . In an alternate embodiment the initiator node can attempt to post the LCE locally. As with the previous error condition should the initiator node fail in the attempt to post the LCE in its local storage repository the initiator node requests the primary node initiate a caller resynchronization event block . The initiating node then initiates the primary election process block 

Yet another error condition involves the non primary initiator node experiencing a communication error with the primary node block . The non primary initiator node responds to this loss of communication with the primary node by initiating the primary node election process block . A local posting of the LCE can also be attempted followed by the non primary node initiating the primary node election process. Also the non primary node forwards a request to the primary node to issue a caller resynchronization event when the attempt at the local posting fails block .

Referring now to wherein is provided a flow chart of a method by which the management tool connects to a single node of the VIOS cluster to retrieve cluster configuration and management data CCM data and subsequently synchronizes the stored CCM data current cluster configuration via automatic updates of detected changes to the cluster where the updates are provided received via use of a single point of communication with the cluster. The method begins at block and proceeds to block at which the management tool connects to a first VIOS of the VIOS cluster and initiates via the first VIOS a discovery operation to discovery initial CCM data including one or more of an identification ID of all nodes existing within the VIOS cluster information data related to one or more of a configuration a topology and a resource allocation of the VIOS cluster life cycle events occurring on the VIOS cluster prior to the discovery etal . As provided herein connecting a management tool to the first VIOS comprises accessing via an adapter on a CEC in which the first VIOS is executing an application programming interface API of the first VIOS. Also initiating a discovery operation comprises forwarding via a command line interface CLI to the API a first management command that triggers a daemon of the first VIOS that is in communication with the API to execute the discovery operation by accessing a shared VIOS database DB to retrieve the listing of nodes and other CCM data stored at the VIOS DB.

The management tool receives the initial CCM data from the discovery operation and stores the received CMC data within a storage that is locally or remotely accessible to the management tool block . The management tool then registers with a single primary notification node of the VIOS cluster to receive information about life cycle events LCEs occurring anywhere within the entire VIOS cluster block . According to one embodiment the process of registering with a single primary notification node of the VIOS cluster to receive information about life cycle events LCEs occurring anywhere within the entire VIOS cluster comprises identifying which node within the VIOS cluster is the primary notification node and registering a transmission control protocol TCP socket of the management tool with an application programming interface API of the single primary notification node. Once the management tool has registered with the primary node the management tool automatically updates the stored CCM data based on LCEs occurring within the cluster block responsive to the management tool receiving a message with information about a LCE associated with the VIOS cluster block . Additionally responsive to receiving a synchronization message from the primary node block the management tool initiates a new discovery operation on the VIOS cluster via the primary node and replaces the stored CCM data within the management tool accessible storage with current CCM data retrieved by the new discovery operation block . Also responsive to detecting a loss of communication with the primary node block the management tool identifies a next node of the VIOS cluster automatically initiates a connection with the next node block . The management tool then performs a new discovery operation on the VIOS cluster via the next node block and registers with a current primary node to receive the LCEs of the VIOS cluster block . The above method thus enables the management tool to maintain scalable data synchronization of the VIOS cluster.

The flowcharts and block diagrams in the various figures presented and described herein illustrate the architecture functionality and operation of possible implementations of systems methods and computer program products according to various embodiments of the present invention. In this regard each block in the flowcharts or block diagrams may represent a module segment or portion of code which comprises one or more executable instructions for implementing the specified logical function s . It should also be noted that in some alternative implementations the functions noted in the block may occur out of the order noted in the figures. For example two blocks shown in succession may in fact be executed substantially concurrently or the blocks may sometimes be executed in the reverse order depending upon the functionality involved. It will also be noted that each block of the block diagrams and or flowchart illustration and combinations of blocks in the block diagrams and or flowchart illustration can be implemented by special purpose hardware based systems that perform the specified functions or acts or combinations of special purpose hardware and computer instructions.

In the flow charts above one or more of the methods are embodied in a computer program product having a computer readable medium containing computer readable program code instructions such that a series of steps are performed when the computer readable program code instructions are executed by a processing unit processor on a computing device machine. In some implementations certain processes of the methods are combined performed simultaneously or in a different order or perhaps omitted without deviating from the spirit and scope of the invention. Thus while the method processes are described and illustrated in a particular sequence use of a specific sequence of processes is not meant to imply any limitations on the invention. Changes may be made with regards to the sequence of processes without departing from the spirit or scope of the present invention. Use of a particular sequence is therefore not to be taken in a limiting sense and the scope of the present invention extends to the appended claims and equivalents thereof.

As will be appreciated by one skilled in the art aspects of the present invention may be embodied as a system method or computer program product. Accordingly aspects of the present invention may take the form of an entirely hardware embodiment an entirely software embodiment including firmware resident software micro code etc. or an embodiment combining software and hardware aspects that may all generally be referred to herein as a circuit module or system. Furthermore aspects of the present invention may take the form of a computer program product embodied in one or more computer readable medium s having computer readable program code embodied thereon.

Any combination of one or more computer readable medium s may be utilized. The computer readable medium may be a computer readable signal medium or a computer readable storage medium. A computer readable storage medium may be for example but not limited to an electronic magnetic optical electromagnetic infrared or semiconductor system apparatus or device or any suitable combination of the foregoing. More specific examples a non exhaustive list of the computer readable storage medium would include the following an electrical connection having one or more wires a portable computer diskette a hard disk a random access memory RAM a read only memory ROM an erasable programmable read only memory EPROM or Flash memory an optical fiber a portable compact disc read only memory CD ROM an optical storage device a magnetic storage device or any suitable combination of the foregoing. In the context of this document a computer readable storage medium may be any tangible medium that can contain or store a program for use by or in connection with an instruction execution system apparatus or device.

A computer readable signal medium may include a propagated data signal with computer readable program code embodied therein for example in baseband or as part of a carrier wave. Such a propagated signal may take any of a variety of forms including but not limited to electro magnetic optical or any suitable combination thereof. A computer readable signal medium may be any computer readable medium that is not a computer readable storage medium and that can communicate propagate or transport a program for use by or in connection with an instruction execution system apparatus or device.

Program code embodied on a computer readable medium may be transmitted using any appropriate medium including but not limited to wireless wireline optical fiber cable R. F etc. or any suitable combination of the foregoing. Computer program code for carrying out operations for aspects of the present invention may be written in any combination of one or more programming languages including an object oriented programming language such as Java Smalltalk C or the like and conventional procedural programming languages such as the C programming language or similar programming languages. The program code may execute entirely on the user s computer partly on the user s computer as a stand alone software package partly on the user s computer and partly on a remote computer or entirely on the remote computer or server. In the latter scenario the remote computer may be connected to the user s computer through any type of network including a local area network LAN or a wide area network WAN or the connection may be made to an external computer for example through the Internet using an Internet Service Provider .

Aspects of the present invention are described below with reference to flowchart illustrations and or block diagrams of methods apparatus systems and computer program products according to embodiments of the invention. It will be understood that each block of the flowchart illustrations and or block diagrams and combinations of blocks in the flowchart illustrations and or block diagrams can be implemented by computer program instructions. These computer program instructions may be provided to a processor of a general purpose computer special purpose computer or other programmable data processing apparatus to produce a machine such that the instructions which execute via the processor of the computer or other programmable data processing apparatus create means for implementing the functions acts specified in the flowchart and or block diagram block or blocks.

These computer program instructions may also be stored in a computer readable medium that can direct a computer other programmable data processing apparatus or other devices to function in a particular manner such that the instructions stored in the computer readable medium produce an article of manufacture including instructions which implement the function act specified in the flowchart and or block diagram block or blocks. The computer program instructions may also be loaded onto a computer other programmable data processing apparatus or other devices to cause a series of operational steps to be performed on the computer other programmable apparatus or other devices to produce a computer implemented process such that the instructions which execute on the computer or other programmable apparatus provide processes for implementing the functions acts specified in the flowchart and or block diagram block or blocks.

As will be further appreciated the processes in embodiments of the present invention may be implemented using any combination of software firmware or hardware. As a preparatory step to practicing the invention in software the programming code whether software or firmware will typically be stored in one or more machine readable storage mediums such as fixed hard drives diskettes optical disks magnetic tape semiconductor memories such as ROMs PROMs etc. thereby making an article of manufacture in accordance with the invention. The article of manufacture containing the programming code is used by either executing the code directly from the storage device by copying the code from the storage device into another storage device such as a hard disk RAM etc. or by transmitting the code for remote execution using transmission type media such as digital and analog communication links. The methods of the invention may be practiced by combining one or more machine readable storage devices containing the code according to the present invention with appropriate processing hardware to execute the code contained therein. An apparatus for practicing the invention could be one or more processing devices and storage systems containing or having network access to program s coded in accordance with the invention.

Thus it is important that while an illustrative embodiment of the present invention is described in the context of a fully functional computer server system with installed or executed software those skilled in the art will appreciate that the software aspects of an illustrative embodiment of the present invention are capable of being distributed as a program product in a variety of forms and that an illustrative embodiment of the present invention applies equally regardless of the particular type of media used to actually carry out the distribution.

While the invention has been described with reference to exemplary embodiments it will be understood by those skilled in the art that various changes may be made and equivalents may be substituted for elements thereof without departing from the scope of the invention. In addition many modifications may be made to adapt a particular system device or component thereof to the teachings of the invention without departing from the essential scope thereof. Therefore it is intended that the invention not be limited to the particular embodiments disclosed for carrying out this invention but that the invention will include all embodiments falling within the scope of the appended claims. Moreover the use of the terms first second etc. do not denote any order or importance but rather the terms first second etc. are used to distinguish one element from another.

The terminology used herein is for the purpose of describing particular embodiments only and is not intended to be limiting of the invention. As used herein the singular forms a an and the are intended to include the plural forms as well unless the context clearly indicates otherwise. It will be further understood that the terms comprises and or comprising when used in this specification specify the presence of stated features integers steps operations elements and or components but do not preclude the presence or addition of one or more other features integers steps operations elements components and or groups thereof.

The corresponding structures materials acts and equivalents of all means or step plus function elements in the claims below are intended to include any structure material or act for performing the function in combination with other claimed elements as specifically claimed. The description of the present invention has been presented for purposes of illustration and description but is not intended to be exhaustive or limited to the invention in the form disclosed. Many modifications and variations will be apparent to those of ordinary skill in the art without departing from the scope and spirit of the invention. The embodiment was chosen and described in order to best explain the principles of the invention and the practical application and to enable others of ordinary skill in the art to understand the invention for various embodiments with various modifications as are suited to the particular use contemplated.

